name: Code Quality

on:
  push:
    branches: [main, master]
  pull_request:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  format:
    name: Black Formatting
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install Black
        run: pip install black

      - name: Check formatting
        run: |
          echo "Checking code formatting with Black..."
          if ! black --check mcp_server/ tests/; then
            echo ""
            echo "❌ Code formatting issues found!"
            echo ""
            echo "To fix, run locally:"
            echo "  black mcp_server/ tests/"
            echo ""
            echo "Or install pre-commit hook:"
            echo "  pip install pre-commit"
            echo "  pre-commit install"
            exit 1
          fi
          echo "✅ All files are properly formatted!"

  lint:
    name: Ruff Linting
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install Ruff
        run: pip install ruff

      - name: Run linter
        run: |
          echo "Running Ruff linter..."
          ruff check mcp_server/ tests/ --output-format=github
          echo "✅ Linting passed!"

  typecheck:
    name: MyPy Type Checking
    runs-on: ubuntu-latest
    continue-on-error: true  # Warning only - doesn't block merge
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          pip install mypy
          pip install -e ".[dev]"

      - name: Run type checker
        run: |
          echo "Running MyPy type checker..."
          mypy mcp_server/ || echo "⚠️ Type checking found issues (informational only)"
